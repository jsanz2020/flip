<odoo>
    <!-- Template principal del flipbook -->
    <template id="flipbook_template" name="Flipbook Viewer">
        <div class="o_flipbook_wrapper" t-att-data-flipbook-id="flipbook_id or 0">
            <div class="flipbook-loading" id="flipbook-loading">
                <i class="fa fa-spinner fa-spin"></i>
                <p>Cargando flipbook...</p>
            </div>
            <div id="flipbook" class="flipbook" style="display: none;"></div>
            <div class="flipbook-error" id="flipbook-error" style="display: none;">
                <i class="fa fa-exclamation-triangle"></i>
                <p>Error cargando el flipbook</p>
                <small>Por favor, verifica que el archivo PDF sea válido</small>
                <button class="btn btn-primary flipbook-retry mt-2">Reintentar</button>
            </div>
        </div>
    </template>

    <!-- Template para página dedicada de flipbook -->
    <template id="flipbook_page_template" name="Flipbook Page">
        <t t-call="website.layout">
            <t t-set="title" t-value="flipbook.name"/>
            <t t-set="meta_description" t-value="flipbook.description or flipbook.name"/>
            
            <div id="wrap" class="oe_structure oe_empty">
                <section class="s_banner pt-5 pb-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12 text-center text-white">
                                <h1 class="display-4 mb-3" t-esc="flipbook.name"/>
                                <p class="lead" t-if="flipbook.description" t-esc="flipbook.description"/>
                                <div class="mt-3">
                                    <span class="badge badge-light mr-2">
                                        <i class="fa fa-eye mr-1"/>
                                        <t t-esc="flipbook.view_count"/> visualizaciones
                                    </span>
                                    <span class="badge badge-light" t-if="flipbook.file_size">
                                        <i class="fa fa-file-pdf-o mr-1"/>
                                        <t t-esc="flipbook.get_formatted_file_size()"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="pt-5 pb-5">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <t t-call="pdf_flipbook_website.flipbook_template">
                                    <t t-set="flipbook_id" t-value="flipbook.id"/>
                                </t>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </t>
    </template>
    <!-- Template para el snippet en el editor -->
    <template id="snippet_flipbook_template" name="PDF Flipbook Snippet Template">
        <section class="s_flipbook_section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <h2 class="text-center mb-4">Flipbook PDF</h2>
                        <t t-call="pdf_flipbook_website.flipbook_template">
                            <t t-set="flipbook_id" t-value="flipbook_id or 0"/>
                        </t>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <!-- Assets adicionales para el frontend -->
    <template id="flipbook_assets" name="Flipbook Assets" inherit_id="website.assets_frontend">
        <xpath expr="//head" position="inside">
            <script type="text/javascript">
                // Configuración global para PDF.js
                if (typeof window !== 'undefined') {
                    window.pdfjsLib = window.pdfjsLib || window['pdfjs-dist/build/pdf'];
                    if (window.pdfjsLib) {
                        window.pdfjsLib.GlobalWorkerOptions = window.pdfjsLib.GlobalWorkerOptions || {};
                        window.pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf_flipbook_website/static/src/lib/pdfjs/pdf.worker.min.js';
                        
                        // Configuración adicional para mejor rendimiento
                        window.pdfjsLib.GlobalWorkerOptions.verbosity = 0; // Reducir logs
                        
                        // Configurar límites de memoria
                        if (window.pdfjsLib.getDocument) {
                            const originalGetDocument = window.pdfjsLib.getDocument;
                            window.pdfjsLib.getDocument = function(src) {
                                if (typeof src === 'string') {
                                    src = { url: src };
                                }
                                src.maxImageSize = src.maxImageSize || 1024 * 1024 * 10; // 10MB
                                src.disableFontFace = src.disableFontFace || false;
                                src.disableRange = src.disableRange || false;
                                src.disableStream = src.disableStream || false;
                                return originalGetDocument(src);
                            };
                        }
                    }
                }
                
                // Detectar soporte para pantalla completa
                window.flipbookSupportsFullscreen = !!(
                    document.fullscreenEnabled ||
                    document.webkitFullscreenEnabled ||
                    document.mozFullScreenEnabled ||
                    document.msFullscreenEnabled
                );
            </script>
        </xpath>
    </template>

    <!-- Template para mostrar lista de flipbooks -->
    <template id="flipbook_list_template" name="Flipbook List">
        <div class="flipbook-list">
            <t t-foreach="flipbooks" t-as="flipbook">
                <div class="flipbook-item card mb-3">
                    <div class="card-body">
                        <h5 class="card-title" t-esc="flipbook.name"/>
                        <p class="card-text" t-esc="flipbook.description"/>
                                <div class="mt-2">
                                    <span class="badge badge-secondary mr-2">
                                        <i class="fa fa-eye mr-1"/>
                                        <t t-esc="flipbook.view_count"/> vistas
                                    </span>
                                    <span class="badge badge-info" t-if="flipbook.file_size">
                                        <i class="fa fa-file-pdf-o mr-1"/>
                                        <t t-esc="flipbook.get_formatted_file_size()"/>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-right">
                                <a t-att-href="'/flipbook/view/%s' % flipbook.id" 
                                   class="btn btn-primary">
                                    <i class="fa fa-book mr-1"/>
                                    Ver Flipbook
                                </a>
                        <div class="flipbook-preview" t-att-data-flipbook-id="flipbook.id">
                        </div>
                        <div class="row mt-3" t-if="show_preview">
                            <div class="col-12">
                                    <a t-att-href="'/flipbook/view/%s' % flipbook.id" 
                                       class="text-decoration-none" 
                                       t-esc="flipbook.name"/>
                            <t t-call="pdf_flipbook_website.flipbook_template">
                                <t t-set="flipbook_id" t-value="flipbook.id"/>
                            </t>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </template>
    
    <!-- Template para widget OWL -->
    <template id="FlipbookWidget" name="Flipbook Widget Template">
        <div class="flipbook-widget-container">
            <div t-if="state.loading" class="flipbook-loading">
                <i class="fa fa-spinner fa-spin fa-2x"/>
                <p>Cargando flipbook...</p>
            </div>
            
            <div t-if="state.error" class="flipbook-error">
                <i class="fa fa-exclamation-triangle fa-2x"/>
                <p t-esc="state.error"/>
                <button class="btn btn-primary mt-2" t-on-click="initializeFlipbook">
                    Reintentar
                </button>
            </div>
            
            <div t-ref="flipbook" 
                 class="flipbook" 
                 t-att-style="state.loading or state.error ? 'display: none' : ''">
            </div>
        </div>
    </template>
</odoo>